<link rel="import" href="../../../lib/polymer/polymer.html">
<link rel="import" href="../../../lib/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../lib/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../../lib/neon-animation/neon-animatable.html">
<link rel="import" href="../../../lib/neon-animation/neon-animations.html">
<link rel="import" href="../../../lib/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../lib/iron-list/iron-list.html">
<link rel="import" href="../../../lib/paper-fab/paper-fab.html">
<link rel="import" href="../../../lib/app-route/app-route.html">
<link rel="import" href="../../../lib/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../AWSLib/awsl-listeditor-behavior">
<link rel="import" href="/elements/lib/awsl-list-toolbar/awsl-list-toolbar.html">
<link rel="import" href="../awsl-editor/awsl-editor.html">

<dom-module id="awsl-listeditor">
    <template>
        <style>
            :host {
                @apply(--layout-vertical);
            }

            iron-list {
                background-color: var(--paper-grey-200, #eee);
                padding-bottom: 16px;
                @apply(--layout-flex);
                @apply(--layout-scroll);
                margin: 8px;
            }

            .item {
                cursor: pointer;
                padding: 16px 22px;
                border-bottom: 1px solid #DDD;
            }

            .item:hover {
                outline: 0;
                background-color: var(--google-grey-300);
                border-bottom: 1px solid #ccc;
            }

            #listContent {
                height:calc(100vh - 64px);
                height:-moz-calc(100vh - 64px);
                height:-webkit-calc(100vh - 64px);
                overflow-x: hidden;
                overflow-y: auto;
            }

            paper-fab {
                position: fixed;
                right: 50px;
                bottom: 50px;
            }
        </style>

        <app-route route="{{route}}"
                   pattern="/:key"
                   data="{{routeData}}"
                   id="routeManager">
        </app-route>

        <neon-animated-pages id="pages" class="flex" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
            <neon-animatable>
                <div id="listContent">
                    <awsl-list-toolbar on-awsl-new="_onNew"></awsl-list-toolbar>
                    <iron-list id="itemsList" as="item" items="[[items]]" scroll-target="listContent">
                    </iron-list>
                </div>
            </neon-animatable>
            <neon-animatable>
                <div>
                    <awsl-editor id="editor" on-saved="_onSaved" on-close="_onClose" oname="{{oname}}"
                                    edithref="[[edithref]]" editelement="[[editelement]]">
                    </awsl-editor>
                </div>
            </neon-animatable>
        </neon-animated-pages>
    </template>
    <script>
        Polymer({
            is: 'awsl-listeditor',
            behaviors: AWSLBehaviors.ListEditorBehavior,

            observers: [
              '_routeChanged(route)',
              '_viewChanged(routeData.key)'
            ],
            _routeChanged: function (newRoute) {
                if (newRoute.path == "")
                {
                    this.set('routeData.key', '');
                }
            },
            _viewChanged: function (key) {
                if (key !== undefined && key != "") {
                    this.key = key;
                    this.$.pages.entryAnimation = "slide-from-right-animation";
                    this.$.pages.exitAnimation = "slide-left-animation";
                    this.$.pages.selected = 1;
                    this.$.editor.load(this.key);
                }
                else {
                    this.reset();
                }
            },

            getItemsList: function () {
                return this.$.itemsList;
            },
            _itemsChanged: function() {
                this.async(function () {
                    if (this.$.listContent.offsetHeight > 0)
                    {
                        this.$.itemsList._render();
                    }
                    else {
                        this._itemsChanged();
                    }
                }, 5);
            },
            getListTemplate: function() {
                var ironlisttemplate = document.createElement('template');

                ironlisttemplate.id = "tempList";

                ironlisttemplate.innerHTML = "<div class='item style-scope awsl-listeditor' on-click='_selectedItemChanged'>"
                    + "<" + this.listelement + " item='[[item]]' />"
                    + "</div>";

                return ironlisttemplate;
            },
            reset: function () {
                if (this.$.pages.selected != 0) {
                    this._onClose();
                }
            },
            _computedClass: function (isSelected) {
                var classes = 'item';
                if (isSelected) {
                    classes += ' selected';
                }
                return classes;
            },
            _selectedItemChanged: function (e) {
                this.key = e.model.item.key;
                this.set('route.path', '/' + this.key);
            },
            _onNew: function () {
                this.key = "0";
                this.set('route.path', '/' + this.key);
            },
            _onClose: function () {
                this.$.pages.entryAnimation = "slide-from-left-animation";
                this.$.pages.exitAnimation = "slide-right-animation";
                this.set('route.path', '');
                this.set('routeData.key', '');
                this.$.pages.selected = 0;
            }
        });
    </script>
</dom-module>
