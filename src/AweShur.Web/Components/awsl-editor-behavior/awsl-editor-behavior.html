<link rel="import" href="../lib/polymer/polymer.html">
<link rel="import" href="../lib/iron-ajax/iron-ajax.html">

<script>
    var AWSLBehaviors = AWSLBehaviors || {};

    (function () {
        AWSLBehaviors.EditorBehavior = {
            properties: {
                key: {
                    type: String,
                },
                edithref: {
                    type: String,
                },
                editelement: {
                    type: String,
                },
                oname: {
                    type: String,
                },
                hiderefresh: {
                    type: Boolean,
                    value: false
                },
                hideadd: {
                    type: Boolean,
                    value: false
                },
                hideokcancel: {
                    type: Boolean,
                    value: false
                },
                theelement: {
                    type: Object,
                    value: function () { return null;}
                },
                ajax: {
                    type: Object
                },
                ajaxread: {
                    type: Object
                }
            },
            wasAttached: false,
            attached: function () {
                if (this.wasAttached) {
                    return;
                }
                this.wasAttached = true;

                this.ajax = document.createElement('iron-ajax');

                this.ajax.method = 'POST';
                this.ajax.contentType = 'application/json';

                this.ajax.addEventListener('response', this.responseHandler.bind(this));
                this.ajax.addEventListener('error', this.responseHandlerError.bind(this));

                this.ajaxread = document.createElement('iron-ajax');

                this.ajaxread.method = 'POST';
                this.ajaxread.contentType = 'application/json';

                this.ajaxread.addEventListener('response', this.responseHandlerRead.bind(this));
                this.ajaxread.addEventListener('error', this.responseHandlerReadError.bind(this));

                this.async(function () {
                    this.importHref(this.edithref, function (e) {
                        var newElement = document.createElement(this.editelement);
                        newElement.id = "theelement";

                        this.theelement = Polymer.dom(this.getMain()).appendChild(newElement);

                        this.fire('elementready');
                    }, function (e) {
                        debugger;
                    });
                });
            },
            load: function () {
                this.ajax.url = "/CRUD/Get/" + this.oname;
                this.ajaxread.url = "/CRUD/Get/" + this.oname + "/" + this.key;

                this.ajaxread.generateRequest();
            },
            responseHandlerRead: function (a, b) {
                if (this.theelement == null) {
                    this.async(function () {
                        this.responseHandlerRead();
                    }, 10);
                }
                else {
                    this.theelement.setData(this.ajaxread.lastResponse);
                }
            },
            responseHandlerReadError: function (event) {
                debugger;
            },
            _new: function () {
                this.key = "0";
                this.load();
            },
            _onOK: function () {
//                this.ajax.generateRequest();
            },
            _onClear: function () {
                this.load();
                this.fire('close');
            },
            responseHandler: function (a, b) {
                if (this.ajax.lastResponse.ok) {
                    this.showMessage(this.ajax.lastResponse.message);

                    this.fire('saved');
                }
                else {
                    if (this.ajax.lastResponse.reload) {
                        window.location.reload();
                    }
                    else {
                        this.showError(this.ajax.lastResponse.message);
                    }
                }
            },
            responseHandlerError: function (event) {
                debugger;
            },
            getMain: function () {
                return null;
            },
            showMessage: function(msg) {
            },
            showError: function (msg) {
            }
        };
    })();
</script>
