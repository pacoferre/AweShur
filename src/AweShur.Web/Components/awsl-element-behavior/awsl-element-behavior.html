<link rel="import" href="../lib/polymer/polymer.html">

<script>
    var AWSLBehaviors = AWSLBehaviors || {};

    (function () {
        AWSLBehaviors.ElementBehavior = {
            properties: {
                item: {
                    type: Object,
                    notify: true,
                    value: function () { return {}; }
                },
                elements: {
                    type: Array,
                    value: function () { return []; }
                },
                dataNames: {
                    type: Array,
                    value: function () { return []; }
                },
                listNames: {
                    type: Array,
                    value: function () { return []; }
                },
                listItems: {
                    type: Array,
                    value: function () { return []; }
                },
                parentElement: {
                    type: Object,
                    value: function () { return null; }
                }
            },
            listeners: {
                'awsl-element-register': '_registerElement',
                'awsl-element-unregister': '_unregisterElement',
                'iron-form-element-register': '_registerIronFormElement',
                'iron-form-element-unregister': '_unregisterElement',
            },

            attached: function () {
                this.fire('awsl-element-register');
            },

            detached: function () {
                if (this.parentElement) {
                    this.parentElement.fire('awsl-element-unregister', { target: this });
                }
            },
            _registerElement: function (e) {
                var element = e.target;

                if (element !== this) {
                    this._registerElementData(element);

                    e.stopPropagation();
                }
            },
            _unregisterElement: function (e) {
                var target = e.detail.target;

                if (target) {
                    var index = this.elements.indexOf(target);
                    if (index > -1) {
                        this.elements.splice(index, 1);
                    }
                }

                e.stopPropagation();
            },
            _registerElementData: function (element)
            {
                var name = element.dataField;

                element.parentElement = this;
                this.elements.push(element);

                if (name != undefined && name != "") {
                    if (this.dataNames.indexOf(name) == -1) {
                        this.dataNames.push(name);
                    }
                }
                if (element.isCustomControl !== undefined) {
                    if (element.isSelector !== undefined) {
                        if (this.listNames.indexOf(element.listName) == -1) {
                            this.listNames.push(element.listName);
                        }
                    }
                }
            },
            _registerIronFormElement: function (e) {
                var element = e.target;

                e.stopPropagation();

                if (element !== this) {

                    if (element.parentNode !== undefined)
                    {
                        if (element.parentNode.isCustomControl !== undefined)
                        {
                            element = element.parentNode;
                        }
                    }

                    if (element.dataField === undefined)
                    {
                        var name = element.getAttribute('data-field');

                        if (name !== null && name != "") {
                            element.dataField = name;
                        }
                    }

                    if (element.dataField !== undefined && element.dataField != "") {
                        this._registerElementData(element);

                        if (element.isCustomControl === undefined) {
                            element.setData = function (fromserver) {
                                var name = this.dataField;

                                if (name != null) {
                                    var value = fromserver.data[name];

                                    if (this.type == 'checkbox' ||
                                        this.type == 'radio' ||
                                        this.getAttribute('role') == 'checkbox' ||
                                        this.getAttribute('role') == 'radio' ||
                                        this['_hasIronCheckedElementBehavior']) {

                                        if (this.checked != (value == '1')) {
                                            this.checked = value == '1';
                                        }
                                    }
                                    else {
                                        if (!this.value || this.value.toString().trim() != value) {
                                            this.value = value;
                                        }
                                    }

                                    if (element.getAttribute('data-onlynew') == "1") {
                                        if (fromserver.isNew) {
                                            this.removeAttribute("readonly");
                                        }
                                        else {
                                            this.setAttribute("readonly", "");
                                        }
                                    }
                                }
                            };
                            element.getData = function () {
                                var name = this.dataField;

                                if (name != null) {
                                    var value;

                                    if (this.type == 'checkbox' ||
                                        this.type == 'radio' ||
                                        this.getAttribute('role') == 'checkbox' ||
                                        this.getAttribute('role') == 'radio' ||
                                        this['_hasIronCheckedElementBehavior']) {

                                        value = this.checked ? '1' : '0';
                                    }
                                    else {
                                        value = this.value;
                                    }

                                    return value;
                                }

                                return "";
                            };
                        }
                    }
                }

                e.stopPropagation();
            },

            setData: function (fromserver, lastChanged) {
                this.setListItems(fromserver);

                for (var el, i = 0; el = this.elements[i], i < this.elements.length; i++) {
                    if (lastChanged != null && el === lastChanged)
                    {
                        if (!el.focused)
                        {
                            el.setData(fromserver);
                        }
                    }
                    else
                    {
                        el.setData(fromserver);
                    }
                }
            },
            getData: function (root) {

                root.data = [];

                for (i = 0; i < this.dataNames.length; i++) {
                    root.data.push("");
                }

                for (var el, i = 0; el = this.elements[i], i < this.elements.length; i++) {
                    var index = this.dataNames.indexOf(el.dataField);

                    if (index > -1)
                    {
                        root.data[index] = el.getData();
                    }
                }
            },

            setListItems: function (fromserver) {
                if (fromserver.listItems != null) {
                    for (var el, i = 0; el = this.elements[i], i < this.elements.length; i++) {
                        if (el.isSelector !== undefined) {
                            el.setListItem(fromserver);
                        }
                    }
                }
            }
        };
    })();
</script>
